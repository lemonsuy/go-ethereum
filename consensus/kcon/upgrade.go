package kcon

import (
	"encoding/hex"
	"fmt"
	"math/big"

	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/core/state"
	"github.com/ethereum/go-ethereum/log"
)

const (
	posaContractAddress = "0x0000000000000000000000000000000000000001"
	posaCode            = "60c060405234801561001057600080fd5b5068056bc75e2d6310000060808181525050600360a0818152505060805160a0516108eb6100576000396000818161019b015261029a0152600061017701526108eb6000f3fe6080604052600436106100595760003560e01c806308dbbb031461006557806309c4fe3814610090578063577ed7e1146100bb57806394cf795e146100f857806396751ae914610123578063a224cee71461014c57610060565b3661006057005b600080fd5b34801561007157600080fd5b5061007a610175565b60405161008791906103ff565b60405180910390f35b34801561009c57600080fd5b506100a5610199565b6040516100b291906103ff565b60405180910390f35b3480156100c757600080fd5b506100e260048036038101906100dd919061045a565b6101bd565b6040516100ef91906104c8565b60405180910390f35b34801561010457600080fd5b5061010d6101fc565b60405161011a91906105a1565b60405180910390f35b34801561012f57600080fd5b5061014a60048036038101906101459190610748565b61028a565b005b34801561015857600080fd5b50610173600480360381019061016e9190610748565b61039c565b005b7f000000000000000000000000000000000000000000000000000000000000000081565b7f000000000000000000000000000000000000000000000000000000000000000081565b600181815481106101cd57600080fd5b906000526020600020016000915054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6060600180548060200260200160405190810160405280929190818152602001828054801561028057602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019060010190808311610236575b5050505050905090565b6001600061029891906103a8565b7f0000000000000000000000000000000000000000000000000000000000000000815111156102fc576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016102f3906107ee565b60405180910390fd5b60005b815181101561039857600182828151811061031d5761031c61080e565b5b60200260200101519080600181540180825580915050600190039060005260206000200160009091909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555080806103909061086c565b9150506102ff565b5050565b6103a58161028a565b50565b50805460008255906000526020600020908101906103c691906103c9565b50565b5b808211156103e25760008160009055506001016103ca565b5090565b6000819050919050565b6103f9816103e6565b82525050565b600060208201905061041460008301846103f0565b92915050565b6000604051905090565b600080fd5b600080fd5b610437816103e6565b811461044257600080fd5b50565b6000813590506104548161042e565b92915050565b6000602082840312156104705761046f610424565b5b600061047e84828501610445565b91505092915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006104b282610487565b9050919050565b6104c2816104a7565b82525050565b60006020820190506104dd60008301846104b9565b92915050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b610518816104a7565b82525050565b600061052a838361050f565b60208301905092915050565b6000602082019050919050565b600061054e826104e3565b61055881856104ee565b9350610563836104ff565b8060005b8381101561059457815161057b888261051e565b975061058683610536565b925050600181019050610567565b5085935050505092915050565b600060208201905081810360008301526105bb8184610543565b905092915050565b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b610611826105c8565b810181811067ffffffffffffffff821117156106305761062f6105d9565b5b80604052505050565b600061064361041a565b905061064f8282610608565b919050565b600067ffffffffffffffff82111561066f5761066e6105d9565b5b602082029050602081019050919050565b600080fd5b61068e816104a7565b811461069957600080fd5b50565b6000813590506106ab81610685565b92915050565b60006106c46106bf84610654565b610639565b905080838252602082019050602084028301858111156106e7576106e6610680565b5b835b8181101561071057806106fc888261069c565b8452602084019350506020810190506106e9565b5050509392505050565b600082601f83011261072f5761072e6105c3565b5b813561073f8482602086016106b1565b91505092915050565b60006020828403121561075e5761075d610424565b5b600082013567ffffffffffffffff81111561077c5761077b610429565b5b6107888482850161071a565b91505092915050565b600082825260208201905092915050565b7f5369676e65727320616d6f756e7420657863656564206c696d69742100000000600082015250565b60006107d8601c83610791565b91506107e3826107a2565b602082019050919050565b60006020820190508181036000830152610807816107cb565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000610877826103e6565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8214156108aa576108a961083d565b5b60018201905091905056fea264697066735822122027218a72b83c1c6d691c5a720650d21d7eecdf094d251c4ab1cfecebbf62dd0264736f6c634300080b0033"
)

func ApplyKConContractUpgrade(blockNumber *big.Int, statedb *state.StateDB) {
	newContractCode, err := hex.DecodeString(posaCode)
	log.Info("Contract Code: ", newContractCode)
	if err != nil {
		panic(fmt.Errorf("failed to decode new contract code: %s", err.Error()))
	}
	statedb.SetCode(common.HexToAddress(posaContractAddress), newContractCode)
}
